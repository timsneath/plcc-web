---
import BaseLayout from '../layouts/BaseLayout.astro'
import { events, type Event, type EventCategory } from '../data/events'

const categories: EventCategory[] = ['Everyone', 'Families', 'Youth', 'Groups', 'Serve']

const selectedCategory = (Astro.url.searchParams.get('c') as EventCategory | null) ?? 'Everyone'

function parseDate(iso: string) {
  return new Date(iso)
}

function formatDay(d: Date) {
  return d.toLocaleDateString('en-US', { weekday: 'short' })
}

function formatDate(d: Date) {
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
}

function formatTime(d: Date) {
  return d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })
}

function weekLabel(d: Date) {
  // Week label like: "Week of Jan 11"
  const label = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
  return `Week of ${label}`
}

const now = new Date()

// Filter: show upcoming (including today), plus “featured” regardless (still sorted by time)
const upcoming = events
  .map((e) => ({ ...e, _start: parseDate(e.start) }))
  .filter((e) => e._start >= new Date(now.getFullYear(), now.getMonth(), now.getDate()))
  .filter((e) => (selectedCategory === 'Everyone' ? true : e.category === selectedCategory))
  .sort((a, b) => a._start.getTime() - b._start.getTime())

const featured = upcoming.filter((e) => e.featured).slice(0, 3)

// Group by week label
const grouped = new Map<string, typeof upcoming>()
for (const e of upcoming) {
  const label = weekLabel(e._start)
  const group = grouped.get(label) ?? []
  group.push(e)
  grouped.set(label, group)
}
---

<BaseLayout title="What’s Happening | Pine Lake Covenant Church">
  <h1>What’s Happening</h1>

  <p style="max-width: 65ch;">
    A curated view of what’s coming up at Pine Lake — the kind of things that are easy to join and a good fit for
    different seasons of life.
  </p>

  <section style="margin-top: 1.5rem;">
    <h2 style="margin-top: 0;">Browse</h2>

    <div style="display:flex; gap: .5rem; flex-wrap: wrap; margin: .75rem 0 1rem;">
      <a
        href={`${import.meta.env.BASE_URL}whats-happening/`}
        class={`chip ${selectedCategory === 'Everyone' ? 'chip--active' : ''}`}
      >
        Everyone
      </a>

      {
        categories
          .filter((c) => c !== 'Everyone')
          .map((c) => (
            <a
              href={`${import.meta.env.BASE_URL}whats-happening/?c=${encodeURIComponent(c)}`}
              class={`chip ${selectedCategory === c ? 'chip--active' : ''}`}
            >
              {c}
            </a>
          ))
      }
    </div>
  </section>

  <section>
    <h2>Featured</h2>

    {
      featured.length === 0 ? (
        <p>No featured events right now — check back soon.</p>
      ) : (
        <div class="event-grid">
          {featured.map((e) => (
            <article class="event-card">
              <div class="event-date">
                <div class="event-day">{formatDay(e._start)}</div>
                <div class="event-md">{formatDate(e._start)}</div>
                <div class="event-time">{formatTime(e._start)}</div>
              </div>

              <div class="event-body">
                <h3 style="margin:0 0 .25rem;">{e.title}</h3>
                <div class="event-meta">
                  <span>{e.category}</span>
                  {e.location && <span> · {e.location}</span>}
                </div>
                <p style="margin:.5rem 0 0;">{e.summary}</p>

                {e.tags?.length ? (
                  <div class="tag-row">
                    {e.tags.map((t) => (
                      <span class="tag">{t}</span>
                    ))}
                  </div>
                ) : null}

                <p style="margin:.75rem 0 0;">
                  <a
                    href={e.url}
                    rel={e.url.startsWith('http') ? 'noopener' : undefined}
                    target={e.url.startsWith('http') ? '_blank' : undefined}
                  >
                    Details
                  </a>
                </p>
              </div>
            </article>
          ))}
        </div>
      )
    }
  </section>

  <section style="margin-top: 2rem;">
    <h2>Coming up</h2>

    {
      upcoming.length === 0 ? (
        <p>No upcoming items in this view right now.</p>
      ) : (
        <>
          {[...grouped.entries()].map(([label, list]) => (
            <div style="margin: 1.25rem 0;">
              <h3 style="margin: 0 0 .5rem;">{label}</h3>

              <div class="event-list">
                {list.map((e) => (
                  <article class="event-row">
                    <div class="event-row__when">
                      <div class="event-row__date">
                        {formatDay(e._start)} · {formatDate(e._start)}
                      </div>
                      <div class="event-row__time">{formatTime(e._start)}</div>
                    </div>

                    <div class="event-row__main">
                      <div class="event-row__title">{e.title}</div>
                      <div class="event-row__meta">
                        {e.category}
                        {e.location ? ` · ${e.location}` : ''}
                        {e.tags?.length ? ` · ${e.tags.join(' · ')}` : ''}
                      </div>
                    </div>

                    <div class="event-row__cta">
                      <a
                        href={e.url}
                        rel={e.url.startsWith('http') ? 'noopener' : undefined}
                        target={e.url.startsWith('http') ? '_blank' : undefined}
                      >
                        Details
                      </a>
                    </div>
                  </article>
                ))}
              </div>
            </div>
          ))}
        </>
      )
    }
  </section>

  <section style="margin-top: 2rem;">
    <h2>Ongoing rhythms</h2>

    <div class="rhythm-grid">
      <div class="rhythm-card">
        <strong>Sundays at 10:00am</strong>
        <div>Worship + teaching, with kids and youth programs.</div>
        <div style="margin-top: .5rem;">
          <a href={`${import.meta.env.BASE_URL}plan-a-visit/`}>Plan a Visit</a>
        </div>
      </div>

      <div class="rhythm-card">
        <strong>Families & Youth</strong>
        <div>Kids and youth are a big part of our life together.</div>
        <div style="margin-top: .5rem;">
          <a href={`${import.meta.env.BASE_URL}families/`}>Families</a>
        </div>
      </div>

      <div class="rhythm-card">
        <strong>Groups & Serving</strong>
        <div>Small groups and serving teams are simple ways to find community.</div>
        <div style="margin-top: .5rem;">
          <a href={`${import.meta.env.BASE_URL}next-steps/`}>Next Steps</a>
        </div>
      </div>
    </div>
  </section>
</BaseLayout>
